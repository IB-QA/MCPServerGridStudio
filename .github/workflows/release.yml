name: Release

on:
  push:
    tags:
      - "v*"
  repository_dispatch:
    types: [publish-release]

permissions:
  contents: write
  id-token: write

jobs:
  publish-release:
    name: Publish Release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine version tag
        id: version
        run: |
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            TAG="${{ github.event.client_payload.tag }}"
          else
            TAG="${{ github.ref_name }}"
          fi
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "Publishing version: $TAG"

      - name: Download artifacts from private repo release
        run: |
          mkdir -p artifacts
          TAG="${{ steps.version.outputs.tag }}"
          echo "Downloading release artifacts for $TAG..."
          gh release download "$TAG" \
            --repo IB-QA/McpServerStudio \
            --pattern "*.vsix" \
            --dir ./artifacts 2>/dev/null || echo "No VSIX found"
          gh release download "$TAG" \
            --repo IB-QA/McpServerStudio \
            --pattern "*.whl" \
            --dir ./artifacts 2>/dev/null || echo "No wheel found"
          gh release download "$TAG" \
            --repo IB-QA/McpServerStudio \
            --pattern "*.tar.gz" \
            --dir ./artifacts 2>/dev/null || echo "No sdist found"
          echo "=== Downloaded artifacts ==="
          ls -la artifacts/
        env:
          GH_TOKEN: ${{ secrets.PRIVATE_REPO_PAT }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Publish to VS Code Marketplace
        run: |
          VSIX_FILE=$(ls artifacts/*.vsix 2>/dev/null | head -1)
          if [ -n "$VSIX_FILE" ]; then
            echo "Publishing $VSIX_FILE to VS Code Marketplace..."
            npx @vscode/vsce publish --packagePath "$VSIX_FILE"
          else
            echo "No VSIX file found, skipping marketplace publish"
          fi
        env:
          VSCE_PAT: ${{ secrets.VSCE_PAT }}

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          files: |
            artifacts/*
          fail_on_unmatched_files: false
          generate_release_notes: true
          draft: false
          prerelease: ${{ contains(steps.version.outputs.tag, 'rc') || contains(steps.version.outputs.tag, 'beta') || contains(steps.version.outputs.tag, 'alpha') }}
          body: |
            ## MCP Grid ${{ steps.version.outputs.tag }}

            ### Install

            **Python package:**
            ```bash
            pip install mcp-grid
            ```

            **VS Code Extension:**
            Search "MCP Grid" in VS Code Extensions, or:
            ```bash
            code --install-extension IBQA.mcp-grid
            ```

            **Marketplace:** [grid.mcpstudio.qabots.diy](https://grid.mcpstudio.qabots.diy)
